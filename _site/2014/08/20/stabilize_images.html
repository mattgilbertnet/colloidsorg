<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <title>Image stabilization and filtering</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/assets/style.css">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/icons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="/assets/js/jquery.colorbox-min.js" type="text/javascript"></script>
<script src="/assets/js/slick.min.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function () {
  // Sticky Header
	createSticky($("#navheader"));


  // Image Gallery
  $('.gallery').colorbox({maxWidth:'100%', maxHeight:'100%', current: "Image {current} of {total}",
    rel:function() {        
        return $(this).data('rel');
    }
	});
	
	// VIdeo Gallery
  if($(window).width() > 700 && $(window).height() > 400){
		$('.videogallery').colorbox({iframe: true, innerWidth: 640, innerHeight: 390, current: "Video {current} of {total}",
			rel:function() {        
					return $(this).data('rel');
			}
		});
	} else {
	  $( "a.videogallery" ).each(function( index ) {
      console.log( "href: " + $( this ).attr('href') );
      console.log( "althref: " + $( this ).attr('data-althref') );
      $( this ).attr('href', $( this ).attr('data-althref'));
    });
	}
	
	
	// Slick Carousel of featured items on the front page
	$('.carousel').slick({
		dots: true,
		infinite: false,
		speed: 300,
		slidesToShow: 4,
		slidesToScroll: 4,
		responsive: [
			{
				breakpoint: 1024,
				settings: {
					slidesToShow: 3,
					slidesToScroll: 3,
					infinite: true,
					dots: true
				}
			},
			{
				breakpoint: 600,
				settings: {
					slidesToShow: 2,
					slidesToScroll: 2
				}
			},
			{
				breakpoint: 480,
				settings: {
					slidesToShow: 1,
					slidesToScroll: 1
				}
			}
			// You can unslick at a given breakpoint now by adding:
			// settings: "unslick"
			// instead of a settings object
		]
	});
	
});

function createSticky(sticky) {
	
	if (typeof sticky !== "undefined") {

		var	pos = sticky.offset().top,
				win = $(window);
			
		win.on("scroll", function() {
    		win.scrollTop() >= pos ? sticky.addClass("fixed") : sticky.removeClass("fixed");      
		});			
	}
}
</script>


  
</head>
<body><header class="container page-header">

  <div class="wrapper"><a class="site-title" rel="author" href="http://peterlu.org/"><img id="logo_header" src="/assets/images/logo_header.png" alt="Peter J. Lu"/></a>
  </div>
</header>

<div id="navheader">
	<div class="site-nav-row row">
		<div class="site-nav-container column">
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
        
						<div class="nav-home"><a href="http://peterlu.org/" alt="Peter J. Lu"><img id="nav_home_logo" src="/assets/images/logo_header_small.png" alt="Peter J. Lu"></a></div>
					<ul>
						<li id="nav-home-slick"><a href="/" alt="Home">Home</a></li>
					
						<li><a href="http://www.peterlu.org/research/" alt="Research">Research</a></li>
					
						<li><a href="http://www.peterlu.org/publications/" alt="Publications">Publications</a></li>
					
						<li><a href="http://www.peterlu.org/press/" alt="Press">Press</a></li>
					
						<li><a href="http://www.peterlu.org/photo/" alt="Photo">Photo</a></li>
					
						<li><a href="http://www.peterlu.org/video/" alt="Video">Video</a></li>
					
						<li><a href="http://www.peterlu.org/about.html" alt="About">About</a></li>
					
					</ul>
        </div>
      </nav>
		</div>
	</div>
</div><div class="container">

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article>
<h1 id="acquiring-and-stabilizing-image-sequences">Acquiring and stabilizing image sequences</h1>

<p>The primary goal of ACE-M2 from a scientific standpoint is to observe the time-evolution of structure and dynamics in samples that may undergo phase separation and/or gelation, in microgravity where sedimentation should not play a role. The stable environment of the ISS and the LMM facilities provide capabilities that are well-suited for this scientific task.</p>

<h2 id="image-acquisition-protocol-for-sample-platter-2105">Image acquisition protocol for sample platter 2105</h2>

<p>In this fourth run of the ACE-M2 experiment, we have successfully collected about five weeks of continuous data from the six samples in platter 2105 which we expect to undergo phase separation and/or gelation in microgravity (wells d1, e4, e5, f3, f4 and f5).</p>

<p>Each day, for each sample, we collect a full tiling at 10x magnification, to image the entire sample well, at six or more depths. Then, we zoom into a selected area away from the stir bar and bubble, and sample chamber edges, and collect a 2x2 tiling (4 images) at 20x magnification, and a 4x4 tiling (16 images) at 40x. We typically collect all of the images at one magnification, moving through all of the samples, then switching objectives, and collecting images from all six samples at a different magnification, in order to maximize efficiency with operator time.</p>

<p>These image sequences give us both the overview of the entire sample chamber (at lower magnification) and a detailed look at smaller, particular structures (at higher magnification), through the entire sequence of the experiment. This is a powerful combination of capabilities gives a multilengthscale view over time, and will hopefully allow us to understand the physics driving the dynamics of these samples.</p>

<h2 id="raw-ace-m2-image-sequences-are-not-spatially-stable">Raw ACE-M2 image sequences are not spatially stable</h2>

<p>Ideally, we could just load the sample images from the same place over time, and look at the temporal evolution, as we rather commonly do with our microscopes on the ground. Unfortunately, this is simply not possible; every 2D image, nominally from the same position, is slightly shifted every time the image is collected. This could be due to drift, or a lack of stage reproducibility—telling the software to bring the stage back to a nominal <em>x-</em> and <em>y-</em> position should physically move to the same location, +/- only a small distance (a couple of microns, based on the testing on the ground). Unfortunately, we seem to see much greater displacements in the stage on orbit, often tens of microns. Here is an example of the 10 composite tiling from sample 22 (platter 2105, strip B618, well 4), collected at a depth of 80 microns from the cover slip on days 3, 5, 8, 11, 15, 18, 29, 32 and 36:</p>

<p><img src="/images/2014_08_21_stabilize_images/p5e4s22_10x_z080_xy1.gif" alt="sample 22, 10x composite, raw images" /></p>

<p><img src="/images/ace_m2_sample_tiles/sample22.png" alt="" /></p>

<p>There a delay of 0.1 sec between each image, with a 2-second delay at the end as the movie loops.</p>

<p>The sample chamber is a circle of diameter 2 mm, and is tiled with 3x4 images, so that the shorter edge of each individual image is roughly a half-mm, or 500 microns. The jumps in position from frame to frame are random, and their magnitude is on the order of a tenth of the image edge length, corresponding to a physical distance of around 50 microns. This is about an order of magnitude <em>higher</em> than the nominal stage reproducibility as measured on the ground—and makes the analysis significantly more complicated. Because these jumps are not deterministic, <strong>the images must be aligned manually, a very slow, tedious process</strong>.</p>

<h3 id="automated-alignment-does-not-work-very-well">Automated alignment does not work very well</h3>

<p>In a <a href="/2014/07/26/preparing_data.html">previous post</a>, I described the quick-and-dirty method using Photoshop to align composite image sequences in an automated fashion. The problem is that the boundaries of the image move around significantly, due to the large stage displacements, which is not only distracting visually, but prevents the analysis of features near the edge of each image. The skipping is apparent at high magnification, here for sample 21 (platter 2105, strip B618, well 5), collected at a depth of 80 microns from the cover slip on days 4, 5, 8, 11, 15, 18, and 32:</p>

<p><img src="/images/2014_08_21_stabilize_images/p5e5s21_20x_z080_xyd_raw_sm.gif" alt="sample 21, 20x raw image sequence" /></p>

<p><img src="/images/ace_m2_sample_tiles/sample21.png" alt="" /></p>

<p>There a delay of 0.5 sec between each image, with a 2-second delay at the end as the movie loops.</p>

<p>Moreover, due to <a href="/2014/08/17/lamp_problems.html">possible fluctuations in lamp intensity</a>, the intensity of images—nominally taken with the same camera settings—is changing, and again in a random, non-deterministic, non-monotonic way.</p>

<h2 id="image-alignment-and-normalization-procedure-for-ace-m2-image-sequences">Image alignment and normalization procedure for ACE-M2 image sequences</h2>

<p><strong>The variation in image intensity and position—which fluctuate essentially randomly—requires each individual image to be aligned and adjusted manually. There is no automated procedure to do this is a consistent way.</strong> These are grayscale images with features that move and change over time; using stabilization software in Adobe After Effects, for instance, does not remove the motion effectively.</p>

<p>I had a very similar experience with early iterations of the BCAT experiment, so this is not surprising, but does limit the scalability of the experiment in terms of the ability to acquire and manage more data. Nonetheless, I have been able to do the alignment and processing, which are necessary to drawing any scientific conclusions, with a multistep procedure.</p>

<h3 id="renaming-the-images">Renaming the images</h3>

<p>As <a href="/2014/07/14/whereis_data.html">previously described</a>, <strong>every single one</strong> of the images in the above sequence has the <strong>same</strong> file name <code class="highlighter-rouge">00004_00030.tif</code>, and resides in a different directory. Because each file has the <strong>same, identical filename</strong>, there is no sensible way to import an image sequence into any existing software package without <strong>manually renaming each and every file one at a time</strong>. Following the <a href="/2014/07/14/whereis_data.html">previously described image naming convention</a>, the sequence of the images in the above file are of the form <code class="highlighter-rouge">p5e5s21_20x_z080_xyd_198.tif</code>, where the last three digits are the numbered day of the year (so the sequence above comprises days 198, 199, 202, 205, 209, 212 and 226).</p>

<h3 id="aligning-and-cropping-the-images">Aligning and cropping the images</h3>

<p>Once renamed, each image is brought into a separate layer in a Photoshop image file, using an included script accessible through the Photoshop CS6 menus: <code class="highlighter-rouge">File &gt; scripts &gt; load files into stacks</code>. These are saved as 8-bit grayscale images, which I convert immediately to a 16-bit grayscale file, to preserve as much image information as possible. The alignment procedure basically involves dragging each layer as close as possible to matching the one below it, which is only barely accelerated with the use of a pen tablet and the arrow keys. Rapidly switching layer visibility allows this process to be done correctly, but requires these tedious manual operations. Once the images are aligned, I crop out the areas that do not occur in every image with the <code class="highlighter-rouge">crop</code> tool.</p>

<h3 id="making-image-intensity-consistent">Making image intensity consistent</h3>

<p>I then filter the images with the <code class="highlighter-rouge">despeckle</code> tool, which takes out the pixel noise without affecting much else. In the <code class="highlighter-rouge">levels</code> dialog box, I set the black and white points so that there is no clipping, maximizing contrast without losing data. This process works much more effectively in 16-bit grayscale, avoiding posterization.</p>

<p>Next, I remove the intensity profile that causes vignetting (brighter in the center; darker in the corners) with the <code class="highlighter-rouge">high pass</code> filter, setting a filter radius of at least 100 pixels, well above the feature size of interest in the images. Then I go back to the <code class="highlighter-rouge">levels</code> dialog box and again re-set the white and black points to avoid clipping as a starting point; then I adjust them and the gamma slider to set the average intensity in each image to a grayscale value of 120 (out of 255), and a standard deviation of 30, using the histogram viewer to facilitate interactive adjustment. I then adjust the mapping in the <code class="highlighter-rouge">curves</code> dialog box to maintain the same average, but increase the standard deviation to 36, making the images easier to view.</p>

<h3 id="preparing-the-animation">Preparing the animation</h3>

<p>Due to noise in the camera’s CCD and general bluriness in the optics, there appears to be no point in presenting the full-size images; therefore, I downsize each image to 50% with a <code class="highlighter-rouge">bicubic smoother</code> option in the <code class="highlighter-rouge">image size</code> dialog box. Then in the <code class="highlighter-rouge">timeline</code> panel, I <code class="highlighter-rouge">create frame animiation</code>, and in its menu, <code class="highlighter-rouge">make frames from layers</code> and <code class="highlighter-rouge">reverse frames</code>. I set the timing, in general, to 0.5 sec per frame, with a 2-second delay at end, before looping (an infinite number of times). Then I export with the <code class="highlighter-rouge">save for web</code> command as an animated <code class="highlighter-rouge">.gif</code> file, as well as individual frames as <code class="highlighter-rouge">.png</code> files.</p>

<p>The resulting final image removes the fluctuations in spatial position and intensity, making the evolution of the sample structure far clearer:</p>

<p><img src="/images/2014_08_21_stabilize_images/p5e5s21_20x_z080_xyd_sm.gif" alt="sample 21, 20x raw image sequence" /></p>

<p><img src="/images/ace_m2_sample_tiles/sample21.png" alt="" /></p>


</article>


      </div>
    </main>
    
    </div><footer>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.colloids.org" property="cc:attributionName" rel="cc:attributionURL">Peter J. Lu</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
</footer>

</body>

</html>
